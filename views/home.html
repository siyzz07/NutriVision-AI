<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | AI Health Pro</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- Icons -->
<style>
:root {
    --primary: #4361ee;
    --secondary: #3f37c9;
    --accent: #4895ef;
    --success: #4cc9f0;
    --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    --card-bg: rgba(255, 255, 255, 0.85);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --border: 1px solid rgba(255, 255, 255, 0.18);
}

body {
    margin: 0;
    font-family: 'Outfit', sans-serif;
    background: #eef2f5;
    color: #2b2d42;
    padding-bottom: 80px; /* Space for footer */
}

/* HEADER */
header {
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 100;
}

header h2 {
    font-size: 22px;
    margin: 0;
    background: linear-gradient(to right, var(--primary), var(--success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 700;
}

.profile-group {
    display: flex;
    gap: 10px;
}

.icon-btn {
    background: #f0f4f8;
    border: none;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    transition: 0.3s;
    font-size: 18px;
}

.icon-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

/* MAIN CONTAINER */
.container {
    padding: 25px;
    max-width: 800px;
    margin: 0 auto;
}

.welcome-box {
    margin-bottom: 25px;
}

.welcome-title {
    font-size: 28px;
    font-weight: 700;
}

.welcome-date {
    color: #8d99ae;
    font-size: 14px;
}

/* HEALTH METRICS GRID */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.metric-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 20px;
    box-shadow: var(--glass-shadow);
    border: var(--border);
    backdrop-filter: blur(4px);
    transition: 0.3s;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
}

.metric-icon {
    font-size: 24px;
    margin-bottom: 10px;
}

.metric-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
    margin-top: 5px;
}

.metric-sub {
    font-size: 11px;
    margin-top: 5px;
}

.status-good { color: #2a9d8f; }
.status-warn { color: #e9c46a; }
.status-bad { color: #e76f51; }

/* AI SCANNER SECTION */
.scanner-section {
    background: white;
    padding: 25px;
    border-radius: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.scanner-header {
    margin-bottom: 20px;
}

.scanner-header h3 {
    margin: 0;
    font-size: 20px;
}

.scanner-header p {
    color: #6c757d;
    font-size: 14px;
    margin-top: 5px;
}

/* ACTION BUTTONS */
.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.big-btn {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 15px;
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn-camera {
    background: linear-gradient(135deg, #4361ee, #3a0ca3);
}

.btn-upload {
    background: linear-gradient(135deg, #4cc9f0, #4361ee);
}

.big-btn:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.big-btn i {
    font-size: 24px;
}

/* SCAN WORKING AREA */
.scan-workspace {
    display: none;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 15px;
}

#video, #uploaded-image {
    width: 100%;
    max-width: 400px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.result-box {
    margin-top: 20px;
    width: 100%;
    text-align: left;
    font-size: 15px;
    line-height: 1.6;
}

.btn-cancel {
    background: #ffdade;
    color: #e63946;
    border: none;
    padding: 10px 20px;
    border-radius: 50px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 15px;
    transition: 0.2s;
}

.btn-cancel:hover {
    background: #ffccd2;
}


/* BOTTOM NAV */
.bottom-nav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    padding: 10px 30px;
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: flex;
    gap: 30px;
    z-index: 1000;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #8d99ae;
    cursor: pointer;
    transition: 0.3s;
    font-size: 12px;
}

.nav-item span {
    font-size: 20px;
    margin-bottom: 2px;
}

.nav-item.active {
    color: var(--primary);
}

.nav-item:hover {
    color: var(--secondary);
    transform: translateY(-2px);
}

/* Responsive */
@media (max-width: 600px) {
    .metrics-grid {
        grid-template-columns: 1fr 1fr;
    }
}
</style>
</head>

<body>

<header>
    <h2>HealthPro AI</h2>
    <div class="profile-group">
        <button class="icon-btn" onclick="goProfile()" title="Profile">üë§</button>
        <button class="icon-btn" onclick="logout()" title="Logout" style="color:#e63946">‚èª</button>
    </div>
</header>

<div class="container">
    <div class="welcome-box">
        <div class="welcome-title">Hello, <span id="user-name">User</span>! üëã</div>
        <div class="welcome-date" id="date-text">Ready to track your health today?</div>
    </div>

    <!-- METRICS -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">‚ù§Ô∏è</div>
            <div class="metric-label">Blood Pressure</div>
            <div class="metric-value">120/80</div>
            <div class="metric-sub status-good">Normal</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">ü©∏</div>
            <div class="metric-label">Cholesterol</div>
            <div class="metric-value">210</div>
            <div class="metric-sub status-warn">mg/dL (High)</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üß™</div>
            <div class="metric-label">SGPT</div>
            <div class="metric-value">70</div>
            <div class="metric-sub status-bad">U/L (Elevated)</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">‚öñÔ∏è</div>
            <div class="metric-label">BMI</div>
            <div class="metric-value">23.5</div>
            <div class="metric-sub status-good">Healthy</div>
        </div>
    </div>

    <!-- AI SCANNER -->
    <div class="scanner-section">
        <div class="scanner-header">
            <h3>AI Food Analyzer</h3>
            <p>Snap a photo or upload an image to get instant nutritional insights.</p>
        </div>

        <!-- MAIN BUTTONS -->
        <div class="action-buttons" id="main-actions">
            <button class="big-btn btn-camera" onclick="startCamera()">
                <span>üì∑</span>
                Use Camera
            </button>
            <button class="big-btn btn-upload" onclick="triggerUpload()">
                <span>üìÅ</span>
                Upload Image
            </button>
        </div>

        <!-- WORKING AREA -->
        <div class="scan-workspace" id="scan-workspace">
            <video id="video" autoplay muted playsinline></video>
            <img id="uploaded-image" alt="Preview">
            
            <div id="result-container" class="result-box"></div>
            
            <button class="btn-cancel" onclick="resetScan()">Cancel / Reset</button>
        </div>

        <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleFileUpload(this)">
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="location.reload()">
        <span>üè†</span>
        Home
    </div>
    <div class="nav-item" onclick="triggerUpload()">
        <span>üì∑</span>
        Scan
    </div>
    <div class="nav-item" onclick="window.location.href='/report'">
        <span>üìä</span>
        Reports
    </div>
    <div class="nav-item" onclick="window.location.href='/profile'">
        <span>‚öôÔ∏è</span>
        Profile
    </div>
</div>

<script>
// --- AUTH & INIT ---
document.addEventListener("DOMContentLoaded", () => {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
        window.location.href = "/login";
        return;
    }
    document.getElementById("user-name").innerText = user.name || "User";
    
    // Set Date
    const options = { weekday: 'long', month: 'long', day: 'numeric' };
    document.getElementById("date-text").innerText = new Date().toLocaleDateString('en-US', options);
});

function goProfile() { window.location.href = "/profile"; }
function logout() { localStorage.removeItem("user"); window.location.href = "/login"; }

// --- UI HELPERS ---
function resetScan() {
    document.getElementById("main-actions").style.display = "flex";
    document.getElementById("scan-workspace").style.display = "none";
    document.getElementById("video").style.display = "none";
    document.getElementById("uploaded-image").style.display = "none";
    document.getElementById("result-container").innerHTML = "";

    // Stop streams
    const video = document.getElementById("video");
    if(video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
    }
}

// --- LOGIC ---
async function analyzeImage(base64Data, mimeType) {
    const resultDiv = document.getElementById("result-container");
    resultDiv.innerHTML = `
        <div style="text-align:center; padding:20px;">
            <div style="font-size:24px; animation:bounce 1s infinite">üß†</div>
            <p>Analyzing food content...</p>
        </div>
        <style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>
    `;

    try {
        const response = await fetch('/api/auth/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64Data, mimeType })
        });
        const data = await response.json();

        if (response.ok) {
            resultDiv.innerHTML = data.html || "‚úÖ Analysis Complete";
        } else {
            resultDiv.innerHTML = `<div style="color:red; background:#ffebeb; padding:10px; border-radius:10px;">‚ùå ${data.message || data.error}</div>`;
        }
    } catch (err) {
        resultDiv.innerHTML = `<div style="color:red">‚ùå Network Error</div>`;
    }
}

function startCamera() {
    document.getElementById("main-actions").style.display = "none";
    document.getElementById("scan-workspace").style.display = "flex";
    const video = document.getElementById("video");
    const resultDiv = document.getElementById("result-container");
    
    video.style.display = "block";
    document.getElementById("uploaded-image").style.display = "none";
    
    resultDiv.innerHTML = "üì∑ Align food... Auto-capturing in 4s...";

    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
            
            setTimeout(() => {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0);
                const base64 = canvas.toDataURL("image/jpeg");
                
                // Stop & Show
                stream.getTracks().forEach(t => t.stop());
                video.style.display = "none"; // Hide video
                const img = document.getElementById("uploaded-image");
                img.src = base64;
                img.style.display = "block"; // Show captured frame
                
                analyzeImage(base64, "image/jpeg");
            }, 4000);
        })
        .catch(err => {
            alert("Camera needed for this feature.");
            resetScan();
        });
    } else {
        alert("Camera not supported.");
        resetScan();
    }
}

function triggerUpload() {
    document.getElementById("file-upload").click();
}

function handleFileUpload(input) {
    if (input.files && input.files[0]) {
        document.getElementById("main-actions").style.display = "none";
        document.getElementById("scan-workspace").style.display = "flex";
        
        const img = document.getElementById("uploaded-image");
        img.style.display = "block";
        document.getElementById("video").style.display = "none";
        
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
            analyzeImage(e.target.result, file.type);
        }
        reader.readAsDataURL(file);
    }
}
</script>

</body>
</html>
